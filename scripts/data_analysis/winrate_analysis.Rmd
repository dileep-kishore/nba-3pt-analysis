---
title: "Three pointer win-rate analysis"
output:
  pdf_document: default
  html_notebook: default
---

```{r, echo=FALSE, message=FALSE}
library(randomForest)
```
*Winrate*
```{r}
winrate <- read.csv('../../results/win_data/comb_winrate.csv')
year_range <- winrate$X
winrate <- subset(winrate, select=-c(X))
summary(winrate)
```

*Threepointer percentage data*
```{r}
percent3p <- read.csv('../../results/team_data/comb_3pper.csv')
year_range <- percent3p$X
percent3p <- subset(percent3p, select=-c(X))
summary(percent3p)
```

*Threepointer attempts data*
```{r}
attempts3p <- read.csv('../../results/team_data/comb_3pattempt.csv')
year_range <- attempts3p$X
attempts3p <- subset(attempts3p, select=-c(X))
summary(attempts3p)
```

*Threepointer made data*
```{r}
made3p <- read.csv('../../results/team_data/comb_3pmade.csv')
year_range <- made3p$X
made3p <- subset(made3p, select=-c(X))
summary(made3p)
```

*Misc data*
```{r}
eff_fg_per <- read.csv('../../results/misc_data/comb_Effective_Field_Goal_Percentage.csv')
ft_per_fg <- read.csv('../../results/misc_data/comb_Free_Throws_Per_Field_Goal_Attempt.csv')
off_reb <- read.csv('../../results/misc_data/comb_Offensive_Rebound_Percentage.csv')
turn_per <- read.csv('../../results/misc_data/comb_Turnover_Percentage.csv')
year_range <- eff_fg_per$X
eff_fg_per <- subset(eff_fg_per, select=-c(X))
ft_per_fg <- subset(ft_per_fg, select=-c(X))
off_reb <- subset(off_reb, select=-c(X))
turn_per <- subset(turn_per, select=-c(X))
```

*Correlation between winrate and threepoint percentage in the last decades*
```{r}
get_lmmodel <- function(start_yr, end_yr, ind_var1, ind_var2, ind_var3, ind_var4)
{
    winrate.list <- c()
    indvar1.list <- c()
    indvar2.list <- c()
    indvar3.list <- c()
    indvar4.list <- c()
    xx.list <- setNames(split(ind_var1, seq(nrow(ind_var1))), year_range)
    yy.list <- setNames(split(ind_var2, seq(nrow(ind_var2))), year_range)
    aa.list <- setNames(split(ind_var3, seq(nrow(ind_var3))), year_range)
    bb.list <- setNames(split(ind_var4, seq(nrow(ind_var4))), year_range)
    yz.list <- setNames(split(winrate, seq(nrow(winrate))), year_range)
    # Change the year range to get models for different time ranges
    yrs <- seq(match(start_yr, year_range), match(end_yr, year_range))
    for (yr_ind in yrs)
    {
        indvar1.list <- c(indvar1.list, as.numeric(xx.list[[yr_ind]]))
        indvar2.list <- c(indvar2.list, as.numeric(yy.list[[yr_ind]]))
        indvar3.list <- c(indvar3.list, as.numeric(aa.list[[yr_ind]]))
        indvar4.list <- c(indvar4.list, as.numeric(bb.list[[yr_ind]]))
        winrate.list <- c(winrate.list, as.numeric(yz.list[[yr_ind]]))
    }
    # Check if these are in order
    # model <- lm(winrate.list ~ indvar1.list*indvar2.list)
    model <- lm(winrate.list ~ indvar1.list+indvar2.list+indvar3.list+indvar4.list)
}
model <- get_lmmodel(2005, 2016, ft_per_fg, eff_fg_per, off_reb, turn_per)
summary(model)
AIC(model)
```



ANNOVA


*Random forest*
```{r}
#set.seed(415)
get_randforest <- function(start_yr, end_yr, ind_var1, ind_var2, ind_var3, ind_var4, ind_var5, ind_var6)
{
    winrate.list <- c()
    indvar1.list <- c()
    indvar2.list <- c()
    indvar3.list <- c()
    indvar4.list <- c()
    indvar5.list <- c()
    indvar6.list <- c()
    xx.list <- setNames(split(ind_var1, seq(nrow(ind_var1))), year_range)
    yy.list <- setNames(split(ind_var2, seq(nrow(ind_var2))), year_range)
    aa.list <- setNames(split(ind_var3, seq(nrow(ind_var3))), year_range)
    bb.list <- setNames(split(ind_var4, seq(nrow(ind_var4))), year_range)
    cc.list <- setNames(split(ind_var5, seq(nrow(ind_var5))), year_range)
    dd.list <- setNames(split(ind_var6, seq(nrow(ind_var6))), year_range)
    yz.list <- setNames(split(winrate, seq(nrow(winrate))), year_range)
    # Change the year range to get models for different time ranges
    yrs <- seq(match(start_yr, year_range), match(end_yr, year_range))
    for (yr_ind in yrs)
    {
        indvar1.list <- c(indvar1.list, as.numeric(xx.list[[yr_ind]]))
        indvar2.list <- c(indvar2.list, as.numeric(yy.list[[yr_ind]]))
        indvar3.list <- c(indvar3.list, as.numeric(aa.list[[yr_ind]]))
        indvar4.list <- c(indvar4.list, as.numeric(bb.list[[yr_ind]]))
        indvar5.list <- c(indvar5.list, as.numeric(cc.list[[yr_ind]]))
        indvar6.list <- c(indvar6.list, as.numeric(dd.list[[yr_ind]]))
        winrate.list <- c(winrate.list, as.numeric(yz.list[[yr_ind]]))
    }
    smp_size <- floor(0.8 * length(winrate.list))
    train_ind <- sample(seq_len(length(winrate.list)), size=smp_size)
    #Training set
    ft_per_fg <- indvar1.list[train_ind]
    eff_fg_per <- indvar1.list[train_ind]
    off_reb <- indvar1.list[train_ind]
    turn_per <- indvar1.list[train_ind]
    made3p <- indvar1.list[train_ind]
    percent3p <- indvar1.list[train_ind]
    winrate <- winrate.list[train_ind]
    train_data <- data.frame(ft_per_fg=ft_per_fg, eff_fg_per=eff_fg_per, off_reb=off_reb, turn_per=turn_per, made3p=made3p, percent3p=percent3p, winrate=winrate)
    # Testing set
    ft_per_fg <- indvar1.list[-train_ind]
    eff_fg_per <- indvar1.list[-train_ind]
    off_reb <- indvar1.list[-train_ind]
    turn_per <- indvar1.list[-train_ind]
    made3p <- indvar1.list[-train_ind]
    percent3p <- indvar1.list[-train_ind]
    winrate <- winrate.list[-train_ind]
    test_data <- data.frame(ft_per_fg=ft_per_fg, eff_fg_per=eff_fg_per, off_reb=off_reb, turn_per=turn_per, made3p=made3p, percent3p=percent3p, winrate=winrate)
    # Check if these are in order
    model <- randomForest(winrate~ft_per_fg+eff_fg_per+off_reb+turn_per+made3p+percent3p, data=train_data, importance=TRUE, ntree=3000)
    prediction <- predict(model, test_data, OOB=TRUE)
    pred_score = mean((test_data$winrate - prediction)^2)
    return(list('model'=model, 'train_data'=train_data, 'prediction'=pred_score))
}
forest_stuff <- get_randforest(2006, 2016, ft_per_fg, eff_fg_per, off_reb, turn_per, made3p, percent3p)
varImpPlot(forest_stuff$model)
print(forest_stuff$prediction)
```
Don't really need to do CV since randomForest already partitions randomly

```{r}
require(ggplot2)
rf <- forest_stuff$model
imp <- importance(rf)
imp = data.frame(type=rownames(imp), importance(rf), check.names=F)
imp$type = reorder(imp$type, imp$`%IncMSE`)
ggplot(data=imp, aes(x=type, y=`%IncMSE`)) + geom_bar(stat='identity') + geom_hline(yintercept=abs(min(imp$`%IncMSE`)), col=2, linetype='dashed') + coord_flip()
```
